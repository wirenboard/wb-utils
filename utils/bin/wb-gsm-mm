#!/bin/bash

reattach_modem_if_needed() {
    if mmcli -m wbc -K | grep -qE "modem\.generic\.state.*(enabled|registered)" && \
       mmcli -m wbc -K | grep -q "modem\.3gpp\.packet-service-state.*detached";
    then
        mmcli -m wbc --3gpp-set-packet-service-state=detached
        sleep 10
        mmcli -m wbc --3gpp-set-packet-service-state=attached
    fi
}

check_restart_modem_needed() {
    modem_info=$(mmcli -m wbc -K)
    
    # Getting supported IP families fails, but modem is in registered state and GPRS is attached
    # It is an invalid state, so we need to restart the modem 
    if echo "$modem_info" | grep -qE "modem\.generic\.state.*registered" && \
       echo "$modem_info" | grep -q "modem\.3gpp\.packet-service-state.*attached";
    then
        if ! echo "$modem_info" | grep -q "modem\.generic\.supported-ip-families"; then
            return 0
        fi
        if echo "$modem_info" | grep -q "modem\.generic\.supported-ip-families\.length.*: 0"; then
            return 0
        fi
    fi
    return 1
}

watchdog() {
    sleep $(($WATCHDOG_USEC / 6000000))
    while true; do
        if lsusb | grep -q "1e0e:9011"; then
            if systemctl is-active --quiet ModemManager; then
                output=$(LC_ALL=C mmcli -m wbc 2>&1)
                if [ $? -ne 0 ] && [ "$output" = "error: couldn't find modem" ]; then
                    echo "ModemManager is running, but modem is not found"
                else
                    if check_restart_modem_needed; then
                        exit 1
                    fi
                    systemd-notify WATCHDOG=1
                    reattach_modem_if_needed
                fi
            else
                systemd-notify WATCHDOG=1
            fi
        fi
        sleep $(($WATCHDOG_USEC / 3000000))
    done
}

wb-gsm mm_off
wb-gsm mm_on
watchdog
